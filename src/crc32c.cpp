#include "crc32c.h"

namespace librats {

// CRC32C (Castagnoli) lookup table
// Polynomial: 0x1EDC6F41 (iSCSI polynomial)
// This table is pre-computed for the Castagnoli polynomial
static const uint32_t crc32c_table[256] = {
    0x00000000, 0xf26b8303, 0xe13b70f7, 0x1350f3f4, 0xc79a971f, 0x35f1141c, 0x26a1e7e8, 0xd4ca64eb,
    0x8ad958cf, 0x78b2dbcc, 0x6be22838, 0x9989ab3b, 0x4d43cfd0, 0xbf284cd3, 0xac78bf27, 0x5e133c24,
    0x105ec76f, 0xe235446c, 0xf165b798, 0x030e349b, 0xd7c45070, 0x25afd373, 0x36ff2087, 0xc494a384,
    0x9a879fa0, 0x68ec1ca3, 0x7bbcef57, 0x89d76c54, 0x5d1d08bf, 0xaf768bbc, 0xbc267848, 0x4e4dfb4b,
    0x20bd8ede, 0xd2d60ddd, 0xc186fe29, 0x33ed7d2a, 0xe72719c1, 0x154c9ac2, 0x061c6936, 0xf477ea35,
    0xaa64d611, 0x580f5512, 0x4b5fa6e6, 0xb93425e5, 0x6dfe410e, 0x9f95c20d, 0x8cc531f9, 0x7eaeb2fa,
    0x30e349b1, 0xc288cab2, 0xd1d83946, 0x23b3ba45, 0xf779deae, 0x05125dad, 0x1642ae59, 0xe4292d5a,
    0xba3a117e, 0x4851927d, 0x5b016189, 0xa96ae28a, 0x7da08661, 0x8fcb0562, 0x9c9bf696, 0x6ef07595,
    0x417b1dbc, 0xb3109ebf, 0xa0406d4b, 0x522bee48, 0x86e18aa3, 0x748a09a0, 0x67dafa54, 0x95b17957,
    0xcba24573, 0x39c9c670, 0x2a993584, 0xd8f2b687, 0x0c38d26c, 0xfe53516f, 0xed03a29b, 0x1f682198,
    0x5125dad3, 0xa34e59d0, 0xb01eaa24, 0x42752927, 0x96bf4dcc, 0x64d4cecf, 0x77843d3b, 0x85efbe38,
    0xdbfc821c, 0x2997011f, 0x3ac7f2eb, 0xc8ac71e8, 0x1c661503, 0xee0d9600, 0xfd5d65f4, 0x0f36e6f7,
    0x61c69362, 0x93ad1061, 0x80fde395, 0x72966096, 0xa65c047d, 0x5437877e, 0x4767748a, 0xb50cf789,
    0xeb1fcbad, 0x197448ae, 0x0a24bb5a, 0xf84f3859, 0x2c855cb2, 0xdeeedfb1, 0xcdbe2c45, 0x3fd5af46,
    0x7198540d, 0x83f3d70e, 0x90a324fa, 0x62c8a7f9, 0xb602c312, 0x44694011, 0x5739b3e5, 0xa55230e6,
    0xfb410cc2, 0x092a8fc1, 0x1a7a7c35, 0xe811ff36, 0x3cdb9bdd, 0xceb018de, 0xdde0eb2a, 0x2f8b6829,
    0x82f63b78, 0x709db87b, 0x63cd4b8f, 0x91a6c88c, 0x456cac67, 0xb7072f64, 0xa457dc90, 0x563c5f93,
    0x082f63b7, 0xfa44e0b4, 0xe9141340, 0x1b7f9043, 0xcfb5f4a8, 0x3dde77ab, 0x2e8e845f, 0xdc45075c,
    0x9208fe17, 0x60637d14, 0x73338ee0, 0x81580de3, 0x55926908, 0xa7f9ea0b, 0xb4a919ff, 0x46c29afc,
    0x18d1a6d8, 0xeaba25db, 0xf9ead62f, 0x0b81552c, 0xdf4b31c7, 0x2d20b2c4, 0x3e704130, 0xcc1bc233,
    0xa2eb97a6, 0x508014a5, 0x43d0e751, 0xb1bb6452, 0x657100b9, 0x971a83ba, 0x844a704e, 0x7621f34d,
    0x2832cf69, 0xda594c6a, 0xc909bf9e, 0x3b623c9d, 0xefe85876, 0x1d83db75, 0x0ed32881, 0xfcb8ab82,
    0xb2f550c9, 0x409ed3ca, 0x53ce203e, 0xa1a5a33d, 0x756fc7d6, 0x870444d5, 0x9454b721, 0x663f3422,
    0x382c0806, 0xca478b05, 0xd91778f1, 0x2b7cfbf2, 0xff969f19, 0x0dfd1c1a, 0x1eadefee, 0xecc66ced,
    0xc3470448, 0x312c874b, 0x227c74bf, 0xd017f7bc, 0x04dd9357, 0xf6b61054, 0xe5e6e3a0, 0x178d60a3,
    0x499e5c87, 0xbbf5df84, 0xa8a52c70, 0x5aceaf73, 0x8e04cb98, 0x7c6f489b, 0x6f3fbb6f, 0x9d54386c,
    0xd319c327, 0x21724024, 0x3222b3d0, 0xc04930d3, 0x14835438, 0xe6e8d73b, 0xf5b824cf, 0x07d3a7cc,
    0x59c09be8, 0xab8b18eb, 0xb8dbeb1f, 0x4ab0681c, 0x9e7a0cf7, 0x6c118ff4, 0x7f417c00, 0x8d2aff03,
    0xe3da8a96, 0x11b10995, 0x02e1fa61, 0xf08a7962, 0x24401d89, 0xd62b9e8a, 0xc57b6d7e, 0x3710ee7d,
    0x6903d259, 0x9b68515a, 0x8838a2ae, 0x7a5321ad, 0xae994546, 0x5cf2c645, 0x4fa235b1, 0xbdc9b6b2,
    0xf3844df9, 0x01efcefa, 0x12bf3d0e, 0xe0d4be0d, 0x341edae6, 0xc67559e5, 0xd525aa11, 0x274e2912,
    0x795d1536, 0x8b369635, 0x986665c1, 0x6a0de6c2, 0xbec78229, 0x4cac012a, 0x5ffcf2de, 0xad9771dd
};

uint32_t crc32c(const void* data, size_t length) {
    const uint8_t* buf = static_cast<const uint8_t*>(data);
    uint32_t crc = 0xFFFFFFFF;
    
    for (size_t i = 0; i < length; ++i) {
        crc = crc32c_table[(crc ^ buf[i]) & 0xFF] ^ (crc >> 8);
    }
    
    return crc ^ 0xFFFFFFFF;
}

uint32_t crc32c_32(uint32_t value) {
    // Process 4 bytes of the value
    uint8_t buf[4];
    buf[0] = static_cast<uint8_t>(value & 0xFF);
    buf[1] = static_cast<uint8_t>((value >> 8) & 0xFF);
    buf[2] = static_cast<uint8_t>((value >> 16) & 0xFF);
    buf[3] = static_cast<uint8_t>((value >> 24) & 0xFF);
    
    return crc32c(buf, 4);
}

uint32_t crc32c_64(uint64_t value) {
    // Process 8 bytes of the value
    uint8_t buf[8];
    buf[0] = static_cast<uint8_t>(value & 0xFF);
    buf[1] = static_cast<uint8_t>((value >> 8) & 0xFF);
    buf[2] = static_cast<uint8_t>((value >> 16) & 0xFF);
    buf[3] = static_cast<uint8_t>((value >> 24) & 0xFF);
    buf[4] = static_cast<uint8_t>((value >> 32) & 0xFF);
    buf[5] = static_cast<uint8_t>((value >> 40) & 0xFF);
    buf[6] = static_cast<uint8_t>((value >> 48) & 0xFF);
    buf[7] = static_cast<uint8_t>((value >> 56) & 0xFF);
    
    return crc32c(buf, 8);
}

} // namespace librats

